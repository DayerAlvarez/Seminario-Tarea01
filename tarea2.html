<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine Image Model - p5.js and ml5.js</title>
    <!-- CDN para gestión de objetos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>

    <!-- CDN para ML -->
    <script src="https://cdn.jsdelivr.net/npm/ml5@0.12/dist/ml5.min.js"></script>
</head>
<body>
    <!-- Contenedor de la barra lateral alineado a la cámara -->
    <div id="sidebar" style="position: absolute; top: 260px; left: 1; width: 300px; background-color: rgba(0, 0, 0, 0.7); padding: 10px; color: white;">
        <div id="barA" class="bar-container">
            <div style="flex: 1;">
                <span id="barLabelA">Loading...</span>
            </div>
            <div style="flex: 2; display: flex; align-items: center;">
                <div id="progressBarA" class="progress-bar"></div>
                <span id="percentageA" style="margin-left: 10px;">0%</span>
            </div>
        </div>
        <div id="barB" class="bar-container">
            <div style="flex: 1;">
                <span id="barLabelB">Loading...</span>
            </div>
            <div style="flex: 2; display: flex; align-items: center;">
                <div id="progressBarB" class="progress-bar"></div>
                <span id="percentageB" style="margin-left: 10px;">0%</span>
            </div>
        </div>
        <div id="barC" class="bar-container">
            <div style="flex: 1;">
                <span id="barLabelC">Loading...</span>
            </div>
            <div style="flex: 2; display: flex; align-items: center;">
                <div id="progressBarC" class="progress-bar"></div>
                <span id="percentageC" style="margin-left: 10px;">0%</span>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // Classifier Variable
        let classifier;
        // Model URL
        let imageModelURL = "./models/";

        // Video
        let video;
        let flippedVideo;
        // To store the classification results
        let results = [];

        // Load the model first
        function preload() {
            classifier = ml5.imageClassifier(imageModelURL + 'model.json');
        }

        function setup() {
            createCanvas(320, 240);
            // Create the video capture
            video = createCapture(VIDEO);
            video.size(320, 240);
            video.hide();

            flippedVideo = ml5.flipImage(video);
            // Start classifying
            classifyVideo();
        }

        function draw() {
            background(0);
            // Draw the video
            image(flippedVideo, 0, 0);

            // Display the top three predictions
            displayResults();
        }

        // Get a prediction for the current video frame
        function classifyVideo() {
            flippedVideo = ml5.flipImage(video);
            classifier.classify(flippedVideo, gotResult);
            flippedVideo.remove();
        }

        // When we get a result
        function gotResult(error, resultsArray) {
            // If there is an error
            if (error) {
                console.error(error);
                return;
            }
            // Save the results
            results = resultsArray;

            // Classify again!
            classifyVideo();
        }

        // Function to display results
        function displayResults() {
            // If there are results, update the display
            if (results.length > 0) {
                // Update the progress bars with the labels and percentages from the results
                updateProgressBar("barA", results[0] ? results[0].confidence : 0, results[0] ? results[0].label : "N/A", "percentageA");
                updateProgressBar("barB", results[1] ? results[1].confidence : 0, results[1] ? results[1].label : "N/A", "percentageB");
                updateProgressBar("barC", results[2] ? results[2].confidence : 0, results[2] ? results[2].label : "N/A", "percentageC");
            }
        }

        // Function to update the progress bars and display percentages
        function updateProgressBar(barId, confidence, label, percentageId) {
            const bar = document.getElementById(barId);
            const labelElement = document.getElementById('barLabel' + barId.charAt(barId.length - 1));
            const percentageElement = document.getElementById(percentageId);
            
            // Update width and color of the progress bar
            bar.style.width = Math.round(confidence * 100) + "%";
            bar.style.backgroundColor = "green";
            
            // Update label and percentage text
            labelElement.innerText = label;
            percentageElement.innerText = Math.round(confidence * 100) + "%";
        }
    </script>

    <style>
        .bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 20px;
            background-color: grey;
            width: 0;
            transition: width 0.5s ease-in-out;
        }

        .bar-container span {
            width: 80px;  /* Reduced width of the label container */
            margin-right: 10px;
        }

        .bar-container #percentageA, .bar-container #percentageB, .bar-container #percentageC {
            margin-left: 10px;
            color: lightgreen;
        }
    </style>
</body>
</html>
